- en: Chapter 10. An End-to-End Example
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have covered enough to get up to speed using Spring Integration in real projects.
    Let's build a real application, which will exercise different types of components
    exposed by the Spring Integration module. This will also act as a refresher chapter
    as we will visit all the concepts discussed so far.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s take an example of the feeds aggregator application; it will aggregate
    feeds based on the configured parameters and then relay it to interested parties.
    Here is the outline of problems we will try to solve. These are just for the sake
    of an example, in a real scenario, we might not need the aggregator or splitter,
    or the sequence of processing itself can be different:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: 'Ingesting data can be done by:'
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Reading RSS feeds
  id: totrans-4
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Reading questions from files on an FTP server
  id: totrans-5
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Filtering data:'
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Filtering the valid/invalid messages based on completion criteria; for simplicity,
    we will filter out `java` questions
  id: totrans-7
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Aggregating messages: Just to showcase the example, we will aggregate and release
    messages in a group of five'
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Splitting a message: The list of aggregated messages will be split and sent
    down the line for further processing'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Transformation:'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Converting a message to a format that can be written in DB
  id: totrans-11
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Converting a message in a JMS format that can be put on a messaging queue
  id: totrans-12
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Converting a message in an e-mail format so that it can be sent to a subscribed
    recipient
  id: totrans-13
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Routing a message based on the message type; entity type to database consumer,
    message type to JMS consumer, and e-mail message to e-mail sender
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Integrating with external systems:'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Writing to DB
  id: totrans-16
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Putting on JMS
  id: totrans-17
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Using an e-mail adapter to send across mails
  id: totrans-18
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'JMX: Exposing Spring endpoints for management and monitoring'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Prerequisites
  id: totrans-20
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Before we can get started with an example, we will need the following software
    in order to import and run the project:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: A Java IDE (preferably STS, but any other IDE such as Eclipse or NetBeans will
    also do)
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: JDK 1.6 and above
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Maven
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: FTP server (this is optional and will only be needed if enabled)
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Setting up
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Once we have all the prerequisites, follow these steps to launch the program:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: Check out the project that you've downloaded with the code bundle. It is a Maven
    project, so using the IDE of your choice, import it as a Maven project.
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Add settings for the e-mail, JMS, and FTP accounts in `settings.properties`:'
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-30
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Keep an FTP and an e-mail account ready.
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run from the main class, that is, `FeedsExample`.
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Ingesting data
  id: totrans-33
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s start with the first step, ingestion of data. We have configured two
    data sources: RSS feeds and an FTP server, let''s take a look at these.'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: Ingesting data from the RSS feed
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '[PRE2]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Tip
  id: totrans-38
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: I will show the code and explain what it does, but will not cover each and every
    tag in detail as they have already been covered in the respective chapters.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: Ingesting data from an FTP server
  id: totrans-40
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now, for this to work, you need an FTP server configured. For testing, you
    can always set up an FTP server locally. Depending on your FTP server location
    and configuration parameters, set up a session factory:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'After we have set up the session factory, it can be used to establish a connection
    with the FTP server. The following code will download the new file from the configured
    `remote-directory` of the FTP and put it in the `local-directory`:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Filtering the data
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The feed and FTP adapter fetch the feed and put it on to `fetchedFeedChannel`.
    Let''s configure a filter, which will allow only Java-related questions, while
    reading the feeds. It will read feeds from the channel `fetchedFeedChannel` and
    pass on the filtered feeds to the channel `fetchedFeedChannelForAggregatior`.
    The following code snippet is the Spring configuration:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Here is the JavaBean class encapsulating the logic of the filter:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The aggregator
  id: totrans-50
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The aggregator is for showcasing the aggregator usage. An aggregator is plugged
    on the output channel of the filter, that is, `fetchedFeedChannelForAggregatior`.
    We will use all the three components of aggregator: correlation, completion, and
    aggregator. Let''s declare the beans:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Once we have defined the three vital components of an aggregator, let''s define
    the component, which will aggregate feeds in a group of five and then release
    only on the next channel:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The correlation bean
  id: totrans-55
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If you remember, the correlation bean holds the strategy to group "related"
    items. We will simply use the category of feeds to group messages:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: The completion bean
  id: totrans-58
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We have correlated the messages, but for how long will we hold on to the list?
    This will will be decided by the completion criteria. Let''s put a very simple
    criteria that if there are five feeds from the same category, then release it
    for further processing. Here is the class implementing this:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: The aggregator bean
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Feeds will be correlated and, after the completion criteria is satisfied, the
    aggregator will return the list on the next endpoint. We have already defined
    the correlation strategy and completion criteria earlier, let''s see the code
    for the aggregator:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: The splitter
  id: totrans-64
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'The JavaBean with the splitter logic:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Transformation
  id: totrans-68
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now that we have feeds in the RSS format, let''s transform it to appropriate
    formats so that the endpoints responsible for persisting in the database, putting
    it on the JMS channel, and sending it as a mail, can understand that. The splitter
    will put one message at a time on the channel `splittedFeedChannel`. Let''s declare
    this as a pub-sub channel and attach three endpoints, which will be our transformers.
    Configure the pub-sub channel as follows:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'The configuration for the three transformers that we have used is as follows:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The DB transformer
  id: totrans-73
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let''s write the transformer component from the Spring Integration and Java
    class that have the transformation logic:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: The JMS transformer
  id: totrans-76
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Here is the code for the JMS transformer component declaration and the corresponding
    JavaBean:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: The mail transformer
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Finally, let''s write the configuration and code for the mail transformer:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Router
  id: totrans-82
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'After transforming the messages to appropriate formats, the transformers put
    the message on to the channel `transformedChannel`. We have three type of messages
    that will be processed by different endpoints. We can use the payload router that
    will route it to different components based on the payload type:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Integration
  id: totrans-85
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now is the time for actual integration! Once the router has routed the message
    to the appropriate endpoints, it should be processed by them. For example, it
    can be persisted to a database, sent on a JMS channel, or sent as an e-mail. Depending
    on the payload type, the router will put the message on to one of the channels
    `jdbcChannel`, `jmsChannel`, or `mailChannel`. If it cannot understand the payload,
    it will route it to `logChannel`. Let's start with the endpoint attached to the
    channel `jdbcChannel` that is used for database integration.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: Database integration
  id: totrans-87
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this section, we will write code to add and query data from a database. Before
    we write adapters from Spring Integration, let's do the basic setup.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
- en: Prerequisites
  id: totrans-89
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'As obvious as it can be, we need a database where we can dump the data. For
    simplicity, we will use the in-memory database. Let''s also configure the ORM
    provider, transaction, and other aspects to be used with the database:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: 'Declaration of the embedded database:'
  id: totrans-91
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-92
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Declaration of the transaction manager:'
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-94
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Declaration of the entity manager factory:'
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-96
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Declaration of the entity manager:'
  id: totrans-97
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Declaration of the abstract vendor adapter:'
  id: totrans-99
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Declaration of the actual vendor adapter, in our case, it is hibernate:'
  id: totrans-101
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE25]'
- en: The gateway
  id: totrans-103
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Let''s define a gateway, which will insert invoke methods to insert feeds and
    then read them back from the database:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'The bean definition for the gateway is as follows:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: The service activator
  id: totrans-108
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'This service activator is plugged in to the `jdbcChannel` channel. When a message
    arrives, its `persistFeedToDb` method is invoked, which uses the preceding gateway
    to persist the feeds:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: Gateways for updating and reading the feeds
  id: totrans-111
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Finally, we plug in the Spring Integration updating and retrieving outbound
    gateways to persist and read back the feed:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Sending a mail
  id: totrans-114
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We can use the Spring Integration mail outbound channel adapter to send out
    mails. It needs a reference to the mail sender class, which has been configured
    as follows:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: 'Spring Integration component for sending mail:'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-117
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE30]'
- en: As evident in the preceding configuration, this adapter is plugged in to `mailChannel`—one
    of the other channels where the router routes the message.
  id: totrans-118
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'The mail sender used by the preceding component:'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-120
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Putting messages on to the JMS queue
  id: totrans-121
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Finally, let''s use the outbound channel adapter to put the message on to a
    JMS queue, this polls the channel `jmsChannel` for a message and whenever router
    routes a message here, it puts it on to the `destination` queue:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'To test the message on the queue, let''s plug in a simple service activator:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'As evident in the preceding configuration, we need `destination` and `connection-factory`,
    let''s configure these:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 从之前的配置中可以看出，我们需要`destination`和`connection-factory`，让我们来配置这些：
- en: '[PRE34]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: Exporting as an MBean
  id: totrans-128
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 导出为MBean
- en: 'Finally, let''s add code to export the components used as MBeans, which can
    be monitored through JConsole or other JMX tools:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，让我们添加代码以导出作为MBean使用的组件，这可以通过JConsole或其他JMX工具进行监控：
- en: '[PRE35]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Summary
  id: totrans-131
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: We covered an end-to-end example in this chapter; I hope this was useful and
    served the purpose of refreshing the concept and a complete use case in one place.
    With this, our Spring Integration journey has ended. I hope you enjoyed it!
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们覆盖了一个端到端的示例；我希望这很有用，并且能在一个地方刷新概念和完整的用例。有了这个，我们的Spring Integration之旅就结束了。我希望你喜欢它！
- en: We covered most common features of the Spring Integration framework and introduced
    enough material to gain momentum. If this book excites you about using Spring
    Integration, the official reference available at [http://docs.spring.io/spring-integration/reference/htmlsingle](http://docs.spring.io/spring-integration/reference/htmlsingle)
    should be your next stop.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 我们覆盖了Spring Integration框架的绝大多数常用特性，并介绍了足够的内容来获得动力。如果这本书让你对使用Spring Integration感到兴奋，那么你的下一个目的地应该是[http://docs.spring.io/spring-integration/reference/htmlsingle](http://docs.spring.io/spring-integration/reference/htmlsingle)官方参考资料。
