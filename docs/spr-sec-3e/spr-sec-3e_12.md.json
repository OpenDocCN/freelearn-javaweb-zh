["```java\n    //build.gradle\n    // Required for JSR-250 based security:\n    // JSR-250 Annotations\n\n compile ('javax.annotation:javax.annotation-api:1.3')    // Already provided by Spring Boot\n *// compile('cglib:cglib-nodep')*    // Already provided by Spring Boot\n    // Required for protect-pointcut\n *// compile('org.aspectj:aspectjweaver')*\n```", "```java\n    .antMatchers(\"/events/\").hasRole(\"ADMIN\")\n```", "```java\n    // allow users with ROLE_ADMIN\n\n    hasRole('ADMIN')\n\n    // allow users that do not have the ROLE_ADMIN\n\n     !hasRole('ADMIN')\n\n    // allow users that have ROLE_ADMIN or ROLE_ROOT and\n    // did not use the remember me feature to login\n\n    fullyAuthenticated() and hasAnyRole('ADMIN','ROOT')\n\n    // allow if Authentication.getName() equals admin\n\n    authentication.name == 'admin'\n```", "```java\n    // allows only HTTP GETrequest.method == 'GET'\n    // allow anyone to perform a GET, but\n    // other methods require ROLE_ADMIN\n\n    request.method == 'GET' ? permitAll : hasRole('ADMIN')\n```", "```java\n    hasIpAddress('192.168.1.93')\n```", "```java\n    hasIpAddress('192.168.1.0/24')\n```", "```java\n$ ifconfig wlan0     Link encap:Ethernet HWaddr a0:88:b4:8b:26:64 inet addr:192.168.1.93 Bcast:192.168.1.255 Mask:255.255.255.0\n```", "```java\n    .antMatchers(\"/events/\").hasRole(\"ADMIN\")\n```", "```java\n//src/main/resources/templates/fragments/header.html\n\n<html xmlns:th=\"http://www.thymeleaf.org\" xmlns:sec=\"http://www.thymeleaf.org/thymeleaf-extras-springsecurity4\">\n...\n<li sec:authorize-url=\"/events/\">\n<a id=\"navEventsLink\" th:href=\"@{/events/}\">All Events</a></li>\n```", "```java\n    <li sec:authorize-url=\"GET /events/\">\n    <a id=\"navEventsLink\" th:href=\"@{/events/}\">All Events</a></li>\n```", "```java\n    //src/main/resources/templates/fragments/header.html\n\n    <li sec:authorize=\"isAuthenticated()\"> \n    <a id=\"navMyEventsLink\" th:href=\"@{/events/my}\">My Events</a></li>\n```", "```java\n//src/main/java/com/packtpub/springsecurity/web/controllers/WelcomeController.java\n\n    @ModelAttribute (\"showCreateLink\")\n    public boolean showCreateLink(Authentication authentication) {\n      return authentication != null && \n      authentication.getName().contains(\"user\");\n    }\n```", "```java\n    //src/main/resources/templates/header.html\n\n    <li th:if=\"${showCreateLink}\"><a id=\"navCreateEventLink\"   \n    th:href=\"@{events/form}\">...</li>\n```", "```java\n//src/main/java/com/packtpub/springsecurity/web/controllers/WelcomeController.java\n\n    @ModelAttribute (\"showAdminLink\")\n    public boolean showAdminLink(Authentication authentication) {\n       return webInvocationPrivilegeEvaluator.\n       isAllowed(\"/admin/\", authentication);\n    }\n```", "```java\n    ApplicationContext context = WebApplicationContextUtils\n     .getRequiredWebApplicationContext(servletContext);\n    WebInvocationPrivilegeEvaluator privEvaluator =\n    context.getBean(WebInvocationPrivilegeEvaluator.class)\n```", "```java\n//src/main/resources/templates/header.html\n\n    <li th:if=\"${showAdminLink}\">\n     <a id=\"h2Link\" th:href=\"@{admin/h2/}\" target=\"_blank\">\n     H2 Database Console</a>\n    ...\n    </li>\n```", "```java\n    import org.springframework.security.access.prepost.PreAuthorize;\n    ...\n    public interface CalendarService {\n       ...\n     @PreAuthorize(\"hasRole('ADMIN')\")\n      List<Event> getEvents();\n    }\n```", "```java\n//src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java\n\n@Configuration\n@EnableWebSecurity\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class SecurityConfig extends WebSecurityConfigurerAdapter {\n```", "```java\n    DEBUG ExceptionTranslationFilter - Access is denied \n    (user is not anonymous); delegating to AccessDeniedHandler\n    org.s.s.access.AccessDeniedException: Access is denied\n    at org.s.s.access.vote.AffirmativeBased.decide\n    at org.s.s.access.intercept.AbstractSecurityInterceptor.\n    beforeInvocation\n    at org.s.s.access.intercept.aopalliance.\n    MethodSecurityInterceptor.invoke\n    ...\n    at $Proxy16.getEvents\n    at com.packtpub.springsecurity.web.controllers.EventsController.events\n```", "```java\n    DefaultCalendarService originalService = context.getBean\n    (CalendarService.class)\n    CalendarService secureService = new CalendarService() {\n     ¦ other methods just delegate to originalService ...\n      public List<Event> getEvents() {\n if(!permitted(originalService.getEvents)) {           throw AccessDeniedException()\n          }\n```", "```java\n       return originalCalendarService.getEvents()\n      }\n   };\n```", "```java\n        //src/main/java/com/packtpub/springsecurity/configuration/\n        SecurityConfig.java\n\n        @Configuration\n        @EnableWebSecurity\n @EnableGlobalMethodSecurity(jsr250Enabled = true)        public class SecurityConfig extends WebSecurityConfigurerAdapter {\n```", "```java\n        @RolesAllowed(\"ROLE_ADMIN\")\n        List<Event> getEvents();\n```", "```java\n    @RolesAllowed({\"ROLE_USER\",\"ROLE_ADMIN\"})\n    List<Event> getEvents();\n```", "```java\n    //src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java\n\n    @EnableWebSecurity(debug = true)\n    @EnableGlobalMethodSecurity(securedEnabled=true)\n    public class SecurityConfig extends WebSecurityConfigurerAdapter {\n```", "```java\n    //src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java\n\n    @Configuration\n    @EnableWebSecurity\n    @EnableGlobalMethodSecurity(prePostEnabled = true)\n    public class SecurityConfig extends WebSecurityConfigurerAdapter {\n    Lastly, we can update our CalendarService interface as follows:\n    @PreAuthorize(\"hasRole('ADMIN') or principal.id == #userId\")  \n    List<Event> findForUser(int userId);\n```", "```java\n    @PostAuthorize(\"hasRole('ROLE_ADMIN') or \" + \"principal.username ==   \n    returnObject.owner.email or \" +\n    \"principal.username == returnObject.attendee.email\")\n    Event getEvent(int eventId);\n```", "```java\n    @PostFilter(\"principal.id == filterObject.owner.id or \" + \n    \"principal.id == filterObject.attendee.id\")\n    List<Event> getEvents();\n```", "```java\n    @PreFilter(\"principal.id == filterObject.owner.id\")\n    void save(Set<Event> events);\n```", "```java\n    build.gradle\n    dependencies {\n       // ACL\n       compile('org.springframework.security:spring-security-acl')\n      compile('net.sf.ehcache:ehcache')\n       ...\n    }\n```", "```java\n    src/main/java/com/packtpub/springsecurity/service/CalendarService.java\n    @PostFilter(\"hasPermission(filterObject, 'read')\")\n    List<Event> getEvents();\n```", "```java\nsrc/main/resources/schema.sql\n-- ACL Schema --\ncreate table acl_sid (\nid bigint generated by default as identity(start with 100) not\n   null primary key,\nprincipal boolean not null,\nsid varchar_ignorecase(100) not null,\nconstraint uk_acl_sid unique(sid,principal) );\n\ncreate table acl_class (\nid bigint generated by default as identity(start with 100) not\n   null primary key,\nclass varchar_ignorecase(500) not null,\nconstraint uk_acl_class unique(class) );\n\ncreate table acl_object_identity (\nid bigint generated by default as identity(start with 100) not\n   null primary key,\nobject_id_class bigint not null,\nobject_id_identity bigint not null,\nparent_object bigint,\nowner_sid bigint not null,\nentries_inheriting boolean not null,\nconstraint uk_acl_objid\n   unique(object_id_class,object_id_identity),\nconstraint fk_acl_obj_parent foreign\n   key(parent_object)references acl_object_identity(id),\nconstraint fk_acl_obj_class foreign\n   key(object_id_class)references acl_class(id),\nconstraint fk_acl_obj_owner foreign key(owner_sid)references\n   acl_sid(id) );\n\ncreate table acl_entry (\nid bigint generated by default as identity(start with 100) not\n   null primary key,\nacl_object_identity bigint not null,\nace_order int not null,\nsid bigint not null,\nmask integer not null,\ngranting boolean not null,\naudit_success boolean not null,\naudit_failure boolean not null,\nconstraint uk_acl_entry unique(acl_object_identity,ace_order),\nconstraint fk_acl_entry_obj_id foreign key(acl_object_identity)\nreferences acl_object_identity(id),\nconstraint fk_acl_entry_sid foreign key(sid) references\n   acl_sid(id) );\n```", "```java\n    src/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java \n @EnableGlobalMethodSecurity(prePostEnabled = true)    @Import(AclConfig.class)\n    public class SecurityConfig extends WebSecurityConfigurerAdapter {\n```", "```java\n    src/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n    @Bean\n    public DefaultMethodSecurityExpressionHandler expressionHandler(){\n       DefaultMethodSecurityExpressionHandler dmseh =\n       new DefaultMethodSecurityExpressionHandler();\n      dmseh.setPermissionEvaluator(permissionEvaluator());\n       dmseh.setPermissionCacheOptimizer(permissionCacheOptimizer());\n       return dmseh; \n    }\n```", "```java\n     src/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n     @Bean\n    public AclPermissionCacheOptimizer permissionCacheOptimizer(){\n       return new AclPermissionCacheOptimizer(aclService());\n    }\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n@Bean\npublic AclPermissionEvaluator permissionEvaluator(){\n   return new AclPermissionEvaluator(aclService());\n}\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n@Autowired \nprivate DataSource dataSource;\n@Bean\npublic JdbcMutableAclService aclService(){\n```", "```java\n   return new JdbcMutableAclService(dataSource,\n                                     lookupStrategy(),\n                                     aclCache());\n}\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n@Bean\npublic LookupStrategy lookupStrategy(){\n   return new BasicLookupStrategy(\n           dataSource,\n           aclCache(),\n           aclAuthorizationStrategy(),\n           consoleAuditLogger());\n}\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n@Bean\npublic EhCacheBasedAclCache aclCache(){\n   return new EhCacheBasedAclCache(ehcache(),\n           permissionGrantingStrategy(),\n           aclAuthorizationStrategy()\n           );\n}\n\n@Bean\npublic PermissionGrantingStrategy permissionGrantingStrategy(){\n   return new DefaultPermissionGrantingStrategy(consoleAuditLogger());\n}\n\n@Bean\npublic Ehcache ehcache(){\n   EhCacheFactoryBean cacheFactoryBean = new EhCacheFactoryBean();\n   cacheFactoryBean.setCacheManager(cacheManager());\n   cacheFactoryBean.setCacheName(\"aclCache\");\n   cacheFactoryBean.setMaxBytesLocalHeap(\"1M\");\n   cacheFactoryBean.setMaxEntriesLocalHeap(0L);\n   cacheFactoryBean.afterPropertiesSet();\n   return cacheFactoryBean.getObject();\n}\n\n@Bean\npublic CacheManager cacheManager(){\n   EhCacheManagerFactoryBean cacheManager = new EhCacheManagerFactoryBean();\n   cacheManager.setAcceptExisting(true);   cacheManager.setCacheManagerName(CacheManager.getInstance().getName());\n   cacheManager.afterPropertiesSet();\nreturn cacheManager.getObject();\n}\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n@Bean\npublic ConsoleAuditLogger consoleAuditLogger(){\n   return new ConsoleAuditLogger();\n}\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n@Bean\npublic AclAuthorizationStrategy aclAuthorizationStrategy() {\n   return new AclAuthorizationStrategyImpl(\n           new SimpleGrantedAuthority(\"ROLE_ADMINISTRATOR\")\n   );\n}\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/SecurityConfig.java\n@Import(AclConfig.class) public class SecurityConfig extends WebSecurityConfigurerAdapter {\n```", "```java\n        src/main/resources/data.sql\n        insert into acl_class (id, class) values (10, \n        'com.packtpub.springsecurity.domain.Event');\n```", "```java\n        src/main/resources/data.sql\n        insert into acl_sid (id, principal, sid) values (20, true,  \n        'user2@example.com');\n        insert into acl_sid (id, principal, sid) values (21, false, \n        'ROLE_USER');\n        insert into acl_sid (id, principal, sid) values (22, false, \n        'ROLE_ADMIN');\n```", "```java\n    src/main/resources/data.sql\n    insert into acl_object_identity(id,object_id_identity,object_id_class,\n    parent_object,owner_sid,entries_inheriting)\n    values (30, 100, 10, null, 20, false);\n    insert into acl_object_identity(id,object_id_identity,object_id_class,\n    parent_object,owner_sid,entries_inheriting) \n    values (31, 101, 10, null, 21, false);\n    insert into acl_object_identity(id,object_id_identity,object_id_class,\n    parent_object,owner_sid,entries_inheriting)\n    values (32, 102, 10, null, 21, false);\n```", "```java\n    src/main/resources/data.sql\n    insert into acl_entry\n   (acl_object_identity, ace_order, sid, mask, granting, audit_success, \n   audit_failure) values(30, 1, 20, 1, true, true, true);\n```", "```java\n    src/main/java/com/packtpub/springsecurity/service/CalendarService.java\n    @PostAuthorize(\"hasPermission(filterObject, 'read') \" +\n    \"or hasPermission(filterObject, 'admin_read')\")\n    Event getEvent(int eventId);\n```", "```java\n    src/main/resources/data.sql\n    insert into acl_entry\n   (acl_object_identity, ace_order, sid, mask, granting, \n   audit_success, audit_failure) values(30, 1, 20, 3, true, true, true);\n```", "```java\n        package com.packtpub.springsecurity.acls.domain;\n        public class CustomPermission extends BasePermission {\n           public static final Permission ADMIN_READ = new \n           CustomPermission(1 << 5, 'M'); // 32\n           public CustomPermission(int mask, char code) {\n               super(mask, code);\n           }\n        }\n```", "```java\n        src/main/java/com/packtpub/springsecurity/configuration/\n        AclConfig.java\n        @Bean\n        public DefaultPermissionFactory permissionFactory(){\n         return new DefaultPermissionFactory(CustomPermission.class);\n        }\n```", "```java\nsrc/main/java/com/packtpub/springsecurity/configuration/AclConfig.java\n@Bean\npublic AclPermissionEvaluator permissionEvaluator(){\n   AclPermissionEvaluator pe = new\n                               AclPermissionEvaluator(aclService());\n pe.setPermissionFactory(permissionFactory());   return pe;\n}\n@Bean\npublic LookupStrategy lookupStrategy(){\n   BasicLookupStrategy ls = new BasicLookupStrategy(\n                                       dataSource,\n                                       aclCache(),\n                                      aclAuthorizationStrategy(),\n                                      consoleAuditLogger());\n ls.setPermissionFactory(permissionFactory());   return ls;\n}\n```", "```java\n        src/main/resources/data.sql\n        insert into acl_sid (id, principal, sid) values (23, true,   \n        'admin1@example.com');\n        insert into acl_entry (acl_object_identity, ace_order, sid, \n        mask, granting, audit_success, audit_failure) \n        values(31, 1, 23, 32, true, true, true);\n```", "```java\n        @PostFilter(\"hasPermission(filterObject, 'read') \" + \"or    \n        hasPermission(filterObject, 'admin_read')\")\n        List<Event> getEvents();\n```", "``` |\n| ```", "``` |\n\n我们可以看到，即使在我们使用简单示例的情况下，我们现在也能够在非常有限的方式上扩展 Spring ACL 功能，以说明这个细粒度访问控制系统的力量。\n\n你的代码应该看起来像`chapter12.03-calendar`。\n\n# 启用 ACL 权限评估\n\n我们在第二章中看到了 Spring Security JSP 标签库提供了将认证相关数据暴露给用户的功能，以及基于多种规则限制用户能看到的内容。在这本书中，我们一直使用的是建立在 Spring Security 之上的 Thymeleaf 安全标签库。\n\n这个相同的标签库也可以与 ACL 启用的系统无缝交互！从我们的简单实验中，我们已经围绕主页上的前两个类别配置了一个简单的 ACL 授权场景。让我们来看看以下步骤，学习如何在 Thymeleaf 页面中启用 ACL 权限评估：\n\n1.  首先，我们需要从我们的`CalendarService`接口中的`getEvents()`方法移除`@PostFilter`注解，以便给我们的 JSP 标签库一个过滤掉不允许显示的事件的机会。现在就移除`@PostFilter`，如下所示：\n\n```", "```\n\n1.  现在我们已经移除了`@PostFilter`，我们可以使用`<sec:authorize-acl>`标签来隐藏用户实际上没有访问权限的事件。回顾一下前一部分的表格，作为对我们迄今为止配置的访问规则的刷新！\n\n1.  我们将用**`<sec:authorize-acl>`**标签包裹每个事件的显示，声明要检查的对象的权限列表：\n\n```", "```\n\n1.  思考一下这里想要发生的事情-我们想要用户只看到他们实际具有`READ`或`ADMIN_READ`（我们的自定义权限）访问的项。然而，为了使用标签库，我们需要使用权限掩码，该掩码可以从以下表格中引用：\n\n| ```", "``` |\n| ```", "``` |\n\n在幕后，标签实现利用了本章早些时候讨论过的相同的`SidRetrievalStrategy`和`ObjectIdentityRetrievalStrategy`接口。因此，访问检查的计算遵循与 ACL 启用的方法安全投票相同的 workflow。正如我们即将看到的，标签实现还将使用相同的`PermissionEvaluator`。\n\n我们已经用一个引用`DefaultMethodSecurityExpressionHandler`的`expressionHandler`元素配置了我们的`GlobalMethodSecurityConfiguration`。`DefaultMethodSecurityExpressionHandler`实现认识我们的`AclPermissionEvaluator`接口，但我们还必须让 Spring Security 的 web 层认识`AclPermissionEvaluator`。如果你仔细思考，这种对称性是合理的，因为保护和 HTTP 请求是保护两种非常不同的资源。幸运的是，Spring Security 的抽象使这一切变得相当简单。\n\n1.  添加一个引用我们已经定义的 ID 为`permissionEvaluator`的 bean 的`DefaultWebSecurityExpressionHandler`处理器：\n\n```", "```\n\n1.  现在，更新`SecurityConfig.java`以引用我们的`webExpressionHandler`实现，如下所示：\n\n```", "```\n\n你可以看到这些步骤与我们向方法安全添加权限处理的方式非常相似。这次简单一些，因为我们能够重用已经配置的具有`PermissionEvaluator` ID 的相同 bean。\n\n启动我们的应用程序，并以不同的用户身份尝试访问所有事件页面。你会发现，不允许用户查看的事件现在使用我们的标签库隐藏，而不是`@PostFilter`注解。我们知道，直接访问事件会让用户看到它。然而，这可以通过将本章中学到的内容与本章中学到的关于`@PostAuthorize`注解的内容相结合轻松实现。\n\n你的代码应该看起来像`chapter12.04-calendar`。\n\n# 可变 ACL 和授权\n\n尽管 JBCP 日历应用程序没有实现完整的用户管理功能，但您的应用程序很可能会有常见功能，例如新用户注册和行政用户维护。到目前为止，这些功能的缺失（我们通过在应用程序启动时使用 SQL 插入解决了这个问题）并没有阻止我们演示 Spring Security 和 Spring ACL 的许多功能。\n\n然而，正确处理声明 ACL 的运行时更改，或系统中的用户添加或删除，对于维护 ACL 基础授权环境的完整性和安全性至关重要。Spring ACL 通过可变 ACL（`o.s.s.acls.model.MutableAcl`）的概念解决了这个问题。\n\n扩展标准 ACL 接口，`MutableAcl`接口允许在运行时操纵 ACL 字段，以改变特定 ACL 的内存表示。这包括创建、更新或删除 ACE 的能力，更改 ACL 所有者，以及其他有用功能。\n\n我们可能期望，Spring ACL 模块会默认提供一种将运行时 ACL 更改持久化到 JDBC 数据存储的方法，的确如此。可以使用`o.s.s.acls.jdbc.JdbcMutableAclService`类来创建、更新和删除数据库中的`MutableAcl`实例，以及执行 ACL 的其他支持表的一般维护（处理`SIDs`、`ObjectIdentity`和域对象类名）。\n\n在本书的早期部分提到，`AclAuthorizationStrategyImpl`类允许我们为可变 ACL 上的操作指定管理角色。这些是在 bean 配置中作为构造函数的一部分提供的。构造函数参数及其含义如下：\n\n| **参数编号** | **它做什么？** |\n| --- | --- |\n| 1 | 表示主体需要具有的权限，以在运行时获取 ACL 保护对象的所有权 |\n| 2 | 表示主体需要具有的权限，以在运行时更改 ACL 保护对象的审计 |\n| 3 | 表示主体需要具有的权限，以在运行时对 ACL 保护的对象进行任何其他类型的更改（创建、更新和删除） |\n\n可能会有所困惑，我们只指定了一个构造函数参数，尽管列出了三个参数。`AclAuthorizationStrategyImpl`类还可以接受一个`GrantedAuthority`，然后将其用于所有三个参数。如果我们要对所有操作使用相同的`GrantedAuthority`，这非常方便。\n\n`JdbcMutableAclService`接口包含用于在运行时操作 ACL 和 ACE 数据的一系列方法。尽管这些方法本身相对容易理解（`createAcl`、`updateAcl`和`deleteAcl`），但即使是高级 Spring Security 用户，配置和使用`JdbcMutableAclService`的正确方式也往往很难掌握。\n\n让我们修改`CalendarService`以创建新事件的新的 ACL。\n\n# 向新创建的事件添加 ACL\n\n目前，如果用户创建了一个新事件，它将不会在所有事件视图中显示给用户，因为我们使用`<sec:authorize-acl>`标签只显示用户有权访问的事件对象。让我们更新我们的`DefaultCalendarService`接口，以便当用户创建一个新事件时，他们被授予读取该事件的权限，并且它将显示在所有事件页面上。\n\n让我们来看看以下步骤，以将 ACL 添加到新创建的事件中：\n\n1.  第一步是更新我们的构造函数以接受`MutableAclService 和 UserContext`：\n\n```", "```\n\n1.  然后，我们需要更新我们的`createEvent`方法，以也为当前用户创建 ACL。进行以下更改：\n\n```"]